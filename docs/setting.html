<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telesapp — Settings</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Dark profile style inspired by your screenshots */
    :root {
      --bg:#0b0f12;
      --card:#12171a;
      --muted:#97a0a8;
      --accent:#00bfff;
      --danger:#ff4d4f;
      --panel:#0f1417;
    }
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;background:var(--bg);color:#e6eef2}
    .container{max-width:760px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;gap:12px;padding:8px 4px;color:#fff}
    .back{font-size:20px;cursor:pointer;padding:8px;border-radius:8px}
    .title{font-size:18px;font-weight:600}
    .profile-card{background:var(--card);border-radius:12px;padding:28px;margin-top:12px;display:flex;flex-direction:column;align-items:center;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .avatar-wrap{position:relative}
    .avatar{
      width:132px;height:132px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.06);background:linear-gradient(180deg,#0b1215,#122026);
      display:block;
    }
    .edit-avatar{
      margin-top:12px;color:var(--danger);cursor:pointer;font-weight:600;
    }
    .list{width:100%;margin-top:18px;border-radius:12px;overflow:hidden}
    .row{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--panel);border-bottom:1px solid rgba(255,255,255,0.02)}
    .row:last-child{border-bottom:0}
    .row .left{display:flex;align-items:center;gap:12px}
    .row .label{color:var(--muted);font-size:13px}
    .row .value{font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    .section-title{margin:18px 0 8px;font-size:13px;color:var(--muted);font-weight:600}
    .controls{display:flex;gap:8px;margin-top:16px}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#021;cursor:pointer;font-weight:600}
    .btn.grey{background:#2a3436;color:#e6eef2}
    .danger{background:var(--danger);color:#fff}
    .file-input{display:none}
    .form-row{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .input, textarea, select{background:#0b1113;border:1px solid rgba(255,255,255,0.04);color:#e6eef2;padding:10px;border-radius:8px;outline:none}
    textarea{min-height:72px;resize:vertical}
    .notice{margin-top:10px;color:#9fb3c0;font-size:13px}
    .blocked-list{list-style:none;padding:0;margin:0}
    .blocked-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:#0e1416;margin-bottom:8px}
    .toast{position:fixed;right:18px;bottom:18px;padding:10px 14px;border-radius:8px;background:#101617;color:#dff;box-shadow:0 6px 20px rgba(0,0,0,0.6);display:none;z-index:999}
    .muted-note{color:var(--muted);font-size:13px;margin-top:6px}
    /* responsive */
    @media (max-width:640px){
      .container{padding:12px}
      .avatar{width:110px;height:110px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="back" onclick="history.back()">←</div>
      <div class="title">You</div>
    </div>

    <!-- Profile card -->
    <div class="profile-card" id="profileCard">
      <div class="avatar-wrap">
        <img id="avatarPreview" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="avatar"/>
      </div>
      <div class="edit-avatar" id="editAvatarBtn">Edit</div>

      <!-- editable fields -->
      <div class="form-row" style="width:100%;max-width:560px;margin-top:16px;">
        <label class="small">Full name</label>
        <input id="fullName" class="input" placeholder="Your full name" />
        <label class="small">About / Bio</label>
        <textarea id="bio" placeholder="Tell people about you..."></textarea>

        <label class="small">Username (unique)</label>
        <input id="username" class="input" placeholder="username (no @)" />

        <label class="small">Email</label>
        <input id="email" class="input" type="email" placeholder="you@example.com" />

        <label class="small">Status</label>
        <input id="status" class="input" placeholder="Available" />

        <div class="controls">
          <button class="btn" id="saveProfileBtn">Save</button>
          <button class="btn grey" id="cancelProfileBtn">Cancel</button>
          <button class="btn danger" id="deleteAccountBtn">Delete Account</button>
        </div>

        <div class="notice">Phone number shown if available (read-only)</div>
      </div>
    </div>

    <!-- quick rows like telegram screenshot -->
    <div class="section-title">Account</div>
    <div class="list">
      <div class="row">
        <div class="left">
          <div class="label">Name</div>
        </div>
        <div class="right">
          <div class="value" id="displayName">—</div>
        </div>
      </div>

      <div class="row">
        <div class="left">
          <div class="label">About</div>
        </div>
        <div class="right">
          <div class="value" id="displayBio">—</div>
        </div>
      </div>

      <div class="row">
        <div class="left">
          <div class="label">Phone</div>
        </div>
        <div class="right">
          <div class="small" id="displayPhone">—</div>
        </div>
      </div>

      <div class="row" onclick="openUsernameEditor()">
        <div class="left">
          <div class="label">Username</div>
        </div>
        <div class="right">
          <div class="value" id="displayUsername">—</div>
        </div>
      </div>

      <div class="row" onclick="openLinksEditor()">
        <div class="left">
          <div class="label">Links</div>
        </div>
        <div class="right">
          <div class="small">Add links</div>
        </div>
      </div>
    </div>

    <!-- Privacy -->
    <div class="section-title">Privacy</div>
    <div class="list" style="padding:12px;">
      <label class="small">Who can see my last seen</label>
      <select id="showLastSeen" class="input" style="margin-top:8px;">
        <option value="everyone">Everyone</option>
        <option value="contacts">My contacts</option>
        <option value="nobody">Nobody</option>
      </select>

      <label class="small" style="margin-top:12px;">Who can see profile photo</label>
      <select id="showProfilePic" class="input" style="margin-top:8px;">
        <option value="everyone">Everyone</option>
        <option value="contacts">My contacts</option>
        <option value="nobody">Nobody</option>
      </select>

      <label class="small" style="margin-top:12px;">Who can see bio</label>
      <select id="showBio" class="input" style="margin-top:8px;">
        <option value="everyone">Everyone</option>
        <option value="contacts">My contacts</option>
        <option value="nobody">Nobody</option>
      </select>

      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn" id="savePrivacyBtn">Save privacy</button>
        <button class="btn grey" id="loadPrivacyBtn">Reload</button>
      </div>
    </div>

    <!-- Notifications -->
    <div class="section-title">Notifications</div>
    <div class="list" style="padding:12px;">
      <label style="display:flex;align-items:center;gap:12px;">
        <input type="checkbox" id="pushEnabled" /> <span class="small">Push notifications</span>
      </label>
      <label style="display:flex;align-items:center;gap:12px;margin-top:8px;">
        <input type="checkbox" id="emailEnabled" /> <span class="small">Email notifications</span>
      </label>

      <label class="small" style="margin-top:12px;">Mute until</label>
      <input id="muteUntil" type="datetime-local" class="input" />

      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn" id="saveNotificationsBtn">Save notifications</button>
        <button class="btn grey" id="loadNotificationsBtn">Reload</button>
      </div>
    </div>

    <!-- Blocked users -->
    <div class="section-title">Blocked users</div>
    <div class="list" style="padding:12px;">
      <ul id="blockedList" class="blocked-list"></ul>
    </div>

  </div>

  <!-- hidden file input -->
  <input id="avatarFile" class="file-input" type="file" accept="image/*" />

  <div id="toast" class="toast"></div>

  <script>
    // ========== Supabase credentials (from your earlier code) ==========
    const SUPABASE_URL = "https://tbbjcxahtnojcuxwevkm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiYmpjeGFodG5vamN1eHdldmttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5ODA0MjMsImV4cCI6MjA3NDU1NjQyM30.mNp1Jj7PNiGXNC1WJDGaaUpJW2C0P7AqnLt3DlGhxqs";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // small helper to show toast messages
    function showToast(msg, timeout = 3500) {
      const el = document.getElementById('toast');
      el.style.display = 'block';
      el.textContent = msg;
      clearTimeout(el._t);
      el._t = setTimeout(()=> el.style.display='none', timeout);
    }

    // store loaded profile for comparisons
    let _profile = null;
    let _user = null;

    async function init() {
      // check auth session immediately
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        // redirect immediately if not authed
        window.location.href = "login.html";
        return;
      }
      _user = session.user;

      // wire UI events
      document.getElementById('editAvatarBtn').addEventListener('click', () => document.getElementById('avatarFile').click());
      document.getElementById('avatarFile').addEventListener('change', handleAvatarUpload);
      document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
      document.getElementById('cancelProfileBtn').addEventListener('click', reloadProfile);
      document.getElementById('savePrivacyBtn').addEventListener('click', savePrivacy);
      document.getElementById('loadPrivacyBtn').addEventListener('click', loadPrivacy);
      document.getElementById('saveNotificationsBtn').addEventListener('click', saveNotifications);
      document.getElementById('loadNotificationsBtn').addEventListener('click', loadNotifications);
      document.getElementById('deleteAccountBtn').addEventListener('click', deleteAccount);

      // initial load
      await loadProfileAndSettings();
    }

    // load profile & related settings
    async function loadProfileAndSettings() {
      try {
        const userId = _user.id;

        // profiles
        const { data: profile, error: pErr } = await supabase
          .from('profiles')
          .select('id,email,full_name,avatar_url,bio,username,status,last_seen')
          .eq('id', userId)
          .single();

        if (pErr && pErr.code !== 'PGRST116') {
          // show error but continue
          console.error('Error loading profile:', pErr);
          // RLS could block reads; show message
          showToast('Error loading profile: ' + (pErr.message || pErr));
        }
        _profile = profile || null;

        // render profile fields
        document.getElementById('displayName').textContent = profile?.full_name || '—';
        document.getElementById('displayBio').textContent = profile?.bio || '—';
        document.getElementById('displayUsername').textContent = profile?.username || 'Create username';
        document.getElementById('displayPhone').textContent = profile?.phone || '—'; // phone is optional
        document.getElementById('avatarPreview').src = profile?.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';

        // fill form inputs
        document.getElementById('fullName').value = profile?.full_name || '';
        document.getElementById('bio').value = profile?.bio || '';
        document.getElementById('username').value = profile?.username || '';
        document.getElementById('email').value = profile?.email || (_user.email || '');
        document.getElementById('status').value = profile?.status || 'Available';

        // privacy settings
        await loadPrivacy();
        // notifications
        await loadNotifications();
        // blocked users
        await loadBlockedUsers();

      } catch (err) {
        console.error(err);
        showToast('Unexpected error: ' + err.message);
      }
    }

    // reload profile (discard local edits)
    async function reloadProfile() {
      await loadProfileAndSettings();
      showToast('Profile reloaded');
    }

    // ========== Avatar upload ==========
    async function handleAvatarUpload(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      // simple size check (optional)
      if (file.size > 6 * 1024 * 1024) {
        return showToast('Image too large (max 6MB)');
      }

      showToast('Uploading avatar...');

      const userId = _user.id;
      // file path inside bucket: avatars/{userId}/{timestamp}_{name}
      const filePath = `${userId}/${Date.now()}_${file.name.replace(/\s+/g,'_')}`;

      // upload
      const { error: uploadErr } = await supabase.storage
        .from('avatars')
        .upload(filePath, file, { cacheControl: '3600', upsert: true });

      if (uploadErr) {
        console.error('Upload error', uploadErr);
        return showToast('Upload failed: ' + (uploadErr.message || uploadErr));
      }

      // get public url
      const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(filePath);
      const publicUrl = urlData?.publicUrl;
      if (!publicUrl) {
        return showToast('Could not get public URL');
      }

      // save into profiles.avatar_url
      const { error: updateErr } = await supabase
        .from('profiles')
        .update({ avatar_url: publicUrl })
        .eq('id', userId);

      if (updateErr) {
        console.error('Error saving avatar to profile', updateErr);
        // Show the preview anyway
        document.getElementById('avatarPreview').src = publicUrl;
        return showToast('Saved avatar locally but failed to update profile: ' + (updateErr.message || updateErr));
      }

      // success
      document.getElementById('avatarPreview').src = publicUrl;
      showToast('Avatar updated');
      // update in-memory
      if (_profile) _profile.avatar_url = publicUrl;
    }

    // ========== Save profile (email, name, username, bio, status) ==========
    async function saveProfile() {
      try {
        const userId = _user.id;
        const newFull = document.getElementById('fullName').value.trim();
        const newBio = document.getElementById('bio').value.trim();
        const newUsername = document.getElementById('username').value.trim() || null;
        const newStatus = document.getElementById('status').value.trim() || null;
        const newEmail = document.getElementById('email').value.trim();

        // update auth email if changed
        if (newEmail && newEmail !== (_profile?.email || _user.email)) {
          showToast('Updating email (you may need to verify)...');
          const { error: authErr } = await supabase.auth.updateUser({ email: newEmail });
          if (authErr) {
            console.error('auth.updateUser error', authErr);
            return showToast('Failed to update auth email: ' + authErr.message);
          }
          showToast('Auth email updated — verify if prompted.');
        }

        // update profiles row
        const updates = {
          full_name: newFull || null,
          bio: newBio || '',
          username: newUsername,
          status: newStatus
        };

        const { error: updErr } = await supabase
          .from('profiles')
          .update(updates)
          .eq('id', userId);

        if (updErr) {
          console.error('Error updating profile', updErr);
          // if there is no profile row yet, try insert (some setups need upsert)
          // Try upsert as fallback (RLS must allow insert)
          const { error: upsertErr } = await supabase
            .from('profiles')
            .upsert({ id: userId, email: newEmail || _profile?.email || _user.email, ...updates });

          if (upsertErr) {
            console.error('Upsert also failed', upsertErr);
            return showToast('Failed to update profile: ' + (upsertErr.message || upsertErr));
          }
        }

        showToast('Profile saved');
        await loadProfileAndSettings();
      } catch (err) {
        console.error(err);
        showToast('Error saving profile: ' + err.message);
      }
    }

    // ========== Privacy ==========
    async function loadPrivacy() {
      try {
        const userId = _user.id;
        const { data, error } = await supabase
          .from('privacy_settings')
          .select('show_last_seen,show_profile_pic,show_bio')
          .eq('user_id', userId)
          .single();

        if (error && error.code !== 'PGRST116') {
          console.warn('privacy load error', error);
        }
        if (data) {
          document.getElementById('showLastSeen').value = data.show_last_seen || 'everyone';
          document.getElementById('showProfilePic').value = data.show_profile_pic || 'everyone';
          document.getElementById('showBio').value = data.show_bio || 'everyone';
        }
      } catch (err) {
        console.error('loadPrivacy', err);
      }
    }

    async function savePrivacy() {
      try {
        const userId = _user.id;
        const updates = {
          user_id: userId,
          show_last_seen: document.getElementById('showLastSeen').value,
          show_profile_pic: document.getElementById('showProfilePic').value,
          show_bio: document.getElementById('showBio').value
        };

        const { error } = await supabase.from('privacy_settings').upsert(updates);
        if (error) {
          console.error('savePrivacy error', error);
          return showToast('Failed to save privacy: ' + (error.message || error));
        }
        showToast('Privacy saved');
      } catch (err) {
        console.error(err);
        showToast('Error saving privacy: ' + err.message);
      }
    }

    // ========== Notifications ==========
    async function loadNotifications() {
      try {
        const userId = _user.id;
        const { data, error } = await supabase
          .from('notification_settings')
          .select('push_enabled,email_enabled,mute_until')
          .eq('user_id', userId)
          .single();

        if (error && error.code !== 'PGRST116') {
          console.warn('notification load error', error);
        }
        if (data) {
          document.getElementById('pushEnabled').checked = !!data.push_enabled;
          document.getElementById('emailEnabled').checked = !!data.email_enabled;
          if (data.mute_until) {
            // convert to input friendly format
            const dt = new Date(data.mute_until);
            const iso = dt.toISOString().slice(0,16);
            document.getElementById('muteUntil').value = iso;
          } else {
            document.getElementById('muteUntil').value = '';
          }
        }
      } catch (err) {
        console.error('loadNotifications', err);
      }
    }

    async function saveNotifications() {
      try {
        const userId = _user.id;
        const updates = {
          user_id: userId,
          push_enabled: !!document.getElementById('pushEnabled').checked,
          email_enabled: !!document.getElementById('emailEnabled').checked,
          mute_until: document.getElementById('muteUntil').value || null
        };

        const { error } = await supabase.from('notification_settings').upsert(updates);
        if (error) {
          console.error('saveNotifications error', error);
          return showToast('Failed to save notifications: ' + (error.message || error));
        }
        showToast('Notifications saved');
      } catch (err) {
        console.error(err);
        showToast('Error saving notifications: ' + err.message);
      }
    }

    // ========== Blocked users ==========
    async function loadBlockedUsers() {
      try {
        const userId = _user.id;
        const { data: blocked, error } = await supabase
          .from('blocked_users')
          .select('blocked_id')
          .eq('blocker_id', userId);

        if (error) {
          console.warn('blocked load', error);
          return;
        }
        const ids = blocked?.map(b => b.blocked_id) || [];
        let profiles = [];
        if (ids.length) {
          const { data: p } = await supabase.from('profiles').select('id,full_name,avatar_url').in('id', ids);
          profiles = p || [];
        }

        const list = document.getElementById('blockedList');
        list.innerHTML = '';
        if (!profiles.length) {
          list.innerHTML = '<div class="muted-note">No blocked users</div>';
          return;
        }
        profiles.forEach(pr => {
          const li = document.createElement('li');
          li.className = 'blocked-item';
          li.innerHTML = `<div style="display:flex;align-items:center;gap:12px"><img src="${pr.avatar_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" style="width:40px;height:40px;border-radius:50%;object-fit:cover"/><div><div style="font-weight:600">${pr.full_name || 'Unnamed'}</div><div class="small">${pr.id}</div></div></div>
            <div><button class="btn grey" onclick='unblock("${pr.id}")'>Unblock</button></div>`;
          list.appendChild(li);
        });
      } catch (err) {
        console.error('loadBlockedUsers', err);
      }
    }

    async function unblock(id) {
      try {
        const userId = _user.id;
        const { error } = await supabase.from('blocked_users').delete()
          .eq('blocker_id', userId)
          .eq('blocked_id', id);
        if (error) {
          console.error('unblock error', error);
          return showToast('Failed to unblock: ' + (error.message || error));
        }
        showToast('User unblocked');
        await loadBlockedUsers();
      } catch (err) {
        console.error(err);
      }
    }

    // ========== Delete Account (cautious) ==========
    async function deleteAccount() {
      if (!confirm('Delete account? This removes your profile row and signs you out. Auth user deletion requires server/service role. Continue?')) return;
      try {
        const userId = _user.id;
        // delete profiles row (RLS must allow delete for owner)
        const { error } = await supabase.from('profiles').delete().eq('id', userId);
        if (error) {
          console.error('delete profile error', error);
          showToast('Failed to delete profile: ' + (error.message || error));
          return;
        }
        showToast('Profile removed — signing out');
        await supabase.auth.signOut();
        window.location.href = 'signup.html';
      } catch (err) {
        console.error(err);
        showToast('Error deleting account: ' + err.message);
      }
    }

    // small helpers for clickable rows (username/links)
    function openUsernameEditor() {
      // scroll to username input
      document.getElementById('username').scrollIntoView({behavior:'smooth',block:'center'});
      document.getElementById('username').focus();
    }
    function openLinksEditor() {
      showToast('Links editor placeholder (you can add a custom UI here)');
    }

    // init
    init();
  </script>
</body>
</html>
