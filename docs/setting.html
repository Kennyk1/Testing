<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }
    .settings-page {
      max-width: 500px;
      margin: 0 auto;
      padding: 1rem;
    }
    h2 {
      margin-top: 2rem;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      color: #555;
    }
    .section {
      background: #fff;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }
    .form-group {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    .form-group label {
      flex: 1;
      color: #333;
      font-weight: 500;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      flex: 2;
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }
    .form-group input[type="checkbox"] {
      flex: 0;
      transform: scale(1.2);
    }
    .avatar-preview {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 1rem;
      border: 2px solid #ddd;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 0.8rem;
      margin-top: 0.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      background: #4a90e2;
      color: white;
    }
    .btn.logout {
      background: #e94e4e;
    }
    .btn.delete {
      background: #888;
    }
    .blocked-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .blocked-list li {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="settings-page">
    <!-- Profile -->
    <h2>Profile</h2>
    <div class="section">
      <div class="form-group">
        <img id="avatar-preview" class="avatar-preview" src="" alt="Avatar" />
        <input type="file" id="avatar-file" />
      </div>
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="full_name" />
      </div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="username" />
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" />
      </div>
      <div class="form-group">
        <label>Bio</label>
        <textarea id="bio" rows="2"></textarea>
      </div>
      <div class="form-group">
        <label>Status</label>
        <input type="text" id="status" />
      </div>
      <button class="btn" id="save-profile">Save Profile</button>
    </div>

    <!-- Privacy -->
    <h2>Privacy</h2>
    <div class="section">
      <div class="form-group">
        <label>Last Seen</label>
        <select id="last_seen">
          <option value="everyone">Everyone</option>
          <option value="contacts">My Contacts</option>
          <option value="nobody">Nobody</option>
        </select>
      </div>
      <div class="form-group">
        <label>Profile Picture</label>
        <select id="profile_pic">
          <option value="everyone">Everyone</option>
          <option value="contacts">My Contacts</option>
          <option value="nobody">Nobody</option>
        </select>
      </div>
      <div class="form-group">
        <label>Bio</label>
        <select id="bio_privacy">
          <option value="everyone">Everyone</option>
          <option value="contacts">My Contacts</option>
          <option value="nobody">Nobody</option>
        </select>
      </div>
      <button class="btn" id="save-privacy">Save Privacy</button>
    </div>

    <!-- Notifications -->
    <h2>Notifications</h2>
    <div class="section">
      <div class="form-group">
        <label>Push Notifications</label>
        <input type="checkbox" id="push_toggle" />
      </div>
      <div class="form-group">
        <label>Email Notifications</label>
        <input type="checkbox" id="email_toggle" />
      </div>
      <div class="form-group">
        <label>Mute Until</label>
        <input type="datetime-local" id="mute_until" />
      </div>
      <button class="btn" id="save-notifications">Save Notifications</button>
    </div>

    <!-- Account -->
    <h2>Account</h2>
    <div class="section">
      <div class="form-group">
        <label>Enable Security Lock</label>
        <input type="checkbox" id="security_enabled" />
      </div>
      <button class="btn logout" id="logout-btn">Logout</button>
      <button class="btn delete" id="delete-account">Delete Account</button>
    </div>

    <!-- Blocked Users -->
    <h2>Blocked Users</h2>
    <div class="section">
      <ul class="blocked-list" id="blocked-list">
        <!-- Blocked users will load here -->
      </ul>
    </div>
  </div>

  <script>
    // ðŸ”‘ Replace with your Supabase keys
    const SUPABASE_URL = "https://tbbjcxahtnojcuxwevkm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiYmpjeGFodG5vamN1eHdldmttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5ODA0MjMsImV4cCI6MjA3NDU1NjQyM30.mNp1Jj7PNiGXNC1WJDGaaUpJW2C0P7AqnLt3DlGhxqs";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ðŸš€ Authentication check
    supabaseClient.auth.getSession().then(({ data: { session } }) => {
      if (!session) {
        window.location.href = "login.html";
      } else {
        loadAllSettings(session.user.id);
      }
    });

    async function loadAllSettings(userId) {
      // Load profile
      const { data: profile } = await supabaseClient.from("profiles").select("*").eq("id", userId).single();
      if (profile) {
        document.getElementById("full_name").value = profile.full_name || "";
        document.getElementById("username").value = profile.username || "";
        document.getElementById("email").value = profile.email || "";
        document.getElementById("bio").value = profile.bio || "";
        document.getElementById("status").value = profile.status || "";
        document.getElementById("avatar-preview").src = profile.avatar_url || "https://via.placeholder.com/60";
        document.getElementById("security_enabled").checked = profile.security_enabled || false;
      }

      // Load privacy
      const { data: privacy } = await supabaseClient.from("privacy_settings").select("*").eq("user_id", userId).single();
      if (privacy) {
        document.getElementById("last_seen").value = privacy.last_seen || "everyone";
        document.getElementById("profile_pic").value = privacy.profile_pic || "everyone";
        document.getElementById("bio_privacy").value = privacy.bio || "everyone";
      }

      // Load notifications
      const { data: notify } = await supabaseClient.from("notification_settings").select("*").eq("user_id", userId).single();
      if (notify) {
        document.getElementById("push_toggle").checked = notify.push_enabled || false;
        document.getElementById("email_toggle").checked = notify.email_enabled || false;
        document.getElementById("mute_until").value = notify.mute_until || "";
      }

      // Load blocked users
      const { data: blocked } = await supabaseClient.from("blocked_users").select("blocked_user_id").eq("user_id", userId);
      const listEl = document.getElementById("blocked-list");
      listEl.innerHTML = "";
      blocked?.forEach(b => {
        const li = document.createElement("li");
        li.textContent = b.blocked_user_id;
        const btn = document.createElement("button");
        btn.textContent = "Unblock";
        btn.onclick = () => unblockUser(userId, b.blocked_user_id);
        li.appendChild(btn);
        listEl.appendChild(li);
      });
    }

    // Save profile
    document.getElementById("save-profile").addEventListener("click", async () => {
      const { data: { user } } = await supabaseClient.auth.getUser();
      const updates = {
        id: user.id,
        full_name: document.getElementById("full_name").value,
        username: document.getElementById("username").value,
        email: document.getElementById("email").value,
        bio: document.getElementById("bio").value,
        status: document.getElementById("status").value,
      };
      await supabaseClient.from("profiles").upsert(updates);
      alert("Profile updated!");
    });

    // Save privacy
    document.getElementById("save-privacy").addEventListener("click", async () => {
      const { data: { user } } = await supabaseClient.auth.getUser();
      const updates = {
        user_id: user.id,
        last_seen: document.getElementById("last_seen").value,
        profile_pic: document.getElementById("profile_pic").value,
        bio: document.getElementById("bio_privacy").value,
      };
      await supabaseClient.from("privacy_settings").upsert(updates);
      alert("Privacy updated!");
    });

    // Save notifications
    document.getElementById("save-notifications").addEventListener("click", async () => {
      const { data: { user } } = await supabaseClient.auth.getUser();
      const updates = {
        user_id: user.id,
        push_enabled: document.getElementById("push_toggle").checked,
        email_enabled: document.getElementById("email_toggle").checked,
        mute_until: document.getElementById("mute_until").value,
      };
      await supabaseClient.from("notification_settings").upsert(updates);
      alert("Notifications updated!");
    });

    // Logout
    document.getElementById("logout-btn").addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      window.location.href = "login.html";
    });

    // Delete account
    document.getElementById("delete-account").addEventListener("click", async () => {
      if (confirm("Are you sure? This cannot be undone.")) {
        const { data: { user } } = await supabaseClient.auth.getUser();
        await supabaseClient.from("profiles").delete().eq("id", user.id);
        await supabaseClient.auth.admin.deleteUser(user.id); // needs service role
        window.location.href = "signup.html";
      }
    });

    // Unblock user
    async function unblockUser(userId, blockedId) {
      await supabaseClient.from("blocked_users").delete().eq("user_id", userId).eq("blocked_user_id", blockedId);
      loadAllSettings(userId);
    }
  </script>
</body>
  </html>
