<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telesapp - Contacts</title>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#121212; color:#ccc; height:100vh; display:flex; flex-direction:column; }
    header { background:#1f1f1f; padding:12px; display:flex; align-items:center; justify-content:space-between; }
    header .logo { font-weight:bold; color:#00bfff; font-size:1.2rem; }
    header .menu { font-size:20px; cursor:pointer; }
    main { flex:1; overflow-y:auto; padding:10px; }
    .contact { padding:12px; background:#1f1f1f; margin-bottom:8px; border-radius:8px; cursor:pointer; }
    .contact:hover { background:#2a2a2a; }
    .floating-btn { position:fixed; bottom:75px; right:25px; background:#e53935; color:#fff; border-radius:50%; width:56px; height:56px; font-size:36px; line-height:56px; text-align:center; cursor:pointer; }
    footer { background:#1f1f1f; padding:12px; text-align:center; color:#00bfff; font-weight:bold; }
  </style>
</head>
<body>
  <header>
    <div class="logo">Telesapp</div>
    <div class="menu">â‹®</div>
  </header>
  <main id="contactsList">
    <p style="text-align:center;color:#888;">No contacts yet. Add one with +</p>
  </main>
  <div class="floating-btn" onclick="newContact()">+</div>
  <footer id="userFooter">Loading...</footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      "https://tbbjcxahtnojcuxwevkm.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiYmpjeGFodG5vamN1eHdldmttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5ODA0MjMsImV4cCI6MjA3NDU1NjQyM30.mNp1Jj7PNiGXNC1WJDGaaUpJW2C0P7AqnLt3DlGhxqs"
    );

    let sessionUser = null;

    async function getSession() {
      const { data: { session } } = await supabase.auth.getSession();
      sessionUser = session?.user;
      if (!sessionUser) window.location.href = "login.html";

      // Load current user profile for footer
      const { data: profile } = await supabase.from("profiles").select("full_name").eq("id", sessionUser.id).single();
      document.getElementById("userFooter").textContent = `Telesapp - ${profile?.full_name || "You"}`;
    }

    async function loadContacts() {
      const { data, error } = await supabase
        .from("contacts")
        .select("contact_id, profiles!fk_contacts_contact_profile(full_name)")
        .eq("owner_id", sessionUser.id);

      const list = document.getElementById("contactsList");
      list.innerHTML = "";
      if (!data || data.length === 0) {
        list.innerHTML = "<p style='text-align:center;color:#888;'>No contacts yet</p>";
        return;
      }
      data.forEach(c => {
        const div = document.createElement("div");
        div.className = "contact";
        div.textContent = c.profiles?.full_name || "Unnamed User";
        div.onclick = () => window.location.href = `chat.html?contactId=${c.contact_id}`;
        list.appendChild(div);
      });
    }

    async function newContact() {
      const email = prompt("Enter user email:");
      if (!email) return;

      // find user by email
      const { data: profile } = await supabase.from("profiles").select("id, full_name").eq("email", email).single();
      if (!profile) {
        alert("User not in Telesapp.");
        return;
      }

      // insert into contacts
      await supabase.from("contacts").insert({
        owner_id: sessionUser.id,
        contact_id: profile.id
      });

      loadContacts();
    }

    (async () => {
      await getSession();
      loadContacts();
    })();
  </script>
</body>
</html>
